#!/usr/bin/env sh
set -eu

if ! command -v php >/dev/null 2>&1; then
  echo "php not found"
  exit 1
fi

if [ ! -f vendor/autoload.php ]; then
  echo "Dependencies not installed. Run: composer install"
  exit 1
fi

PHP_FILES_Z="$(git diff --cached --name-only -z --diff-filter=ACMR -- '*.php' || true)"

if [ -n "$PHP_FILES_Z" ]; then
  echo "Running Pint on staged PHP files..."
  printf "%s" "$PHP_FILES_Z" | xargs -0 php ./vendor/bin/pint --
  printf "%s" "$PHP_FILES_Z" | xargs -0 git add --
fi

echo "Running PHPStan (level 5)..."
php ./vendor/bin/phpstan analyse -c phpstan.neon.dist --no-progress

echo "Running Pest..."
php ./vendor/bin/pest
